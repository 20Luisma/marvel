name: CI - Clean Marvel Tests

env:
  TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}

on:
  push:
    branches:
      - main
      - 'feature/*'
      - 'hotfix/*'
      - 'release/*'
      - staging
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, dom, json, pdo, sqlite
          coverage: pcov

      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist --no-progress

      - name: Composer security audit
        run: composer security:audit

      - name: Validate Composer configuration
        run: composer validate --strict

      - name: Run PHPUnit tests
        run: |
          if [ -f vendor/bin/phpunit ]; then
            mkdir -p build/logs
            php -d pcov.enabled=1 -d pcov.directory=. vendor/bin/phpunit --configuration phpunit.xml.dist --coverage-clover build/logs/clover.xml
            if [ -s build/logs/clover.xml ]; then
              echo "Coverage file detected at build/logs/clover.xml"
            else
              echo "Primary clover output missing, searching fallback coverage files"
              fallback_file="$(find . -maxdepth 4 -type f \( -name 'clover.xml' -o -name 'coverage.xml' \) | head -n 1)"
              if [ -n "${fallback_file}" ]; then
                cp "${fallback_file}" build/logs/clover.xml
                echo "Coverage file normalized from ${fallback_file} to build/logs/clover.xml"
              fi
            fi
            if [ ! -s build/logs/clover.xml ]; then
              echo "::warning::Coverage files not found after PHPUnit run. Coverage gate will be skipped for this run."
              echo "SKIP_COVERAGE_GATE=1" >> "$GITHUB_ENV"
              php -v
              php -m | grep -Ei "pcov|xdebug" || true
              find . -maxdepth 4 -type f \( -name 'clover.xml' -o -name 'coverage.xml' \) -print || true
              ls -la
              ls -la build || true
              ls -la build/logs || true
            fi
          else
            echo "PHPUnit no encontrado"
            exit 1
          fi

      # Coverage gate (Clover): fails CI if total statement coverage drops below COVERAGE_THRESHOLD (default 75).
      - name: Enforce coverage threshold
        if: env.SKIP_COVERAGE_GATE != '1'
        env:
          COVERAGE_THRESHOLD: ${{ vars.COVERAGE_THRESHOLD || 75 }}
        run: php scripts/coverage-gate.php build/logs/clover.xml

      - name: Coverage gate skipped (diagnostic mode)
        if: env.SKIP_COVERAGE_GATE == '1'
        run: echo "::warning::Coverage gate skipped because clover.xml was not generated by PHPUnit in this run."

      - name: Upload clover coverage artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: clover-coverage
          path: build/logs/clover.xml
          if-no-files-found: ignore

      - name: Run PHPStan analysis
        run: |
          if [ -f vendor/bin/phpstan ]; then
            vendor/bin/phpstan analyse --memory-limit=1G
          else
            echo "PHPStan no encontrado"
            exit 1
          fi

  tests:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Confirm existing test stage
        run: echo "Tests ejecutados en el job build; etapa placeholder para dependencias posteriores."

  # ðŸŸª SONARCLOUD (CALIDAD + BUGS + VULNERABILIDADES + COVERAGE)
  sonarcloud:
    runs-on: ubuntu-latest
    needs: [build, tests]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup PHP 8.2 (coverage)
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, dom, json, pdo, sqlite
          coverage: pcov

      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist --no-progress

      - name: Generar bundle size (JS/CSS)
        run: php bin/generate-bundle-size.php

      - name: Download clover coverage artifact (from build)
        uses: actions/download-artifact@v4
        with:
          name: clover-coverage
          path: build/logs
        continue-on-error: true

      - name: Ensure clover coverage for Sonar
        run: |
          mkdir -p build/logs
          if [ -s build/logs/clover.xml ]; then
            echo "âœ… Using clover.xml downloaded from build artifact."
          else
            echo "âš ï¸ Artifact missing clover.xml; regenerating with pcov."
            php -d pcov.enabled=1 -d pcov.directory=. vendor/bin/phpunit --configuration phpunit.xml.dist --coverage-clover build/logs/clover.xml
          fi

      - name: Debug coverage report (pre-scan)
        run: |
          ls -la build/logs
          if [ -s build/logs/clover.xml ]; then
            head -n 5 build/logs/clover.xml
            php -r '$xml=simplexml_load_file("build/logs/clover.xml"); $m=$xml?($xml->project->metrics??null):null; $s=$m?intval($m["statements"]):0; $c=$m?intval($m["coveredstatements"]):0; $p=$s>0?($c/$s*100):0; echo "Coverage summary: covered {$c}/{$s} statements = ".number_format($p,2)."%\n";'
            echo "SONAR_COVERAGE_ARGS=-Dsonar.php.coverage.reportPaths=build/logs/clover.xml" >> "$GITHUB_ENV"
          else
            echo "::warning::clover.xml not found in sonar job; running SonarCloud scan without coverage report path."
            echo "SONAR_COVERAGE_ARGS=" >> "$GITHUB_ENV"
          fi

      - name: SonarCloud Scan
        uses: sonarsource/sonarcloud-github-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: ${{ env.SONAR_COVERAGE_ARGS }}

  # ðŸŸ¦ PA11Y (ACCESIBILIDAD AA)
  pa11y:
    runs-on: ubuntu-latest
    needs: [build, tests]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist --no-progress

      - name: Seed storage
        run: |
          mkdir -p storage/json storage/logs
          if [ -d storage.example ]; then
            cp -r storage.example/* storage/json/ || true
            for f in storage.example/*.json; do
              basename_f=$(basename "$f")
              [ -f "$f" ] && cp -n "$f" "storage/$basename_f" || true
            done
          fi
          # Permisos para que PHP pueda escribir
          chmod -R 777 storage

      - name: Install Node dependencies
        run: npm ci

      - name: Start PHP server (router)
        run: php -S 0.0.0.0:8080 -t public public/index.php >/tmp/php-server.log 2>&1 &

      - name: Run Pa11y audits
        run: |
          mkdir -p pa11y-reports
          urls=(/ /heroes /albums /comic /movies)
          FINAL_EXIT_CODE=0
          for url in "${urls[@]}"; do
            safe_name=$(echo "${url#/}" | tr '/' '-')
            if [ "$url" == "/" ]; then safe_name="index"; fi
            echo "Running Pa11y for http://localhost:8080${url}"
            npx pa11y "http://localhost:8080${url}" --standard WCAG2AA --reporter json --chrome-args="--no-sandbox --disable-setuid-sandbox" > "pa11y-reports/${safe_name}.json" || {
              EXIT_CODE=$?
              if [ $EXIT_CODE -eq 1 ]; then
                echo "Pa11y found accessibility issues in ${url} (exit code 1), but this will not fail the job."
              else
                echo "Pa11y failed to run for ${url} (exit code $EXIT_CODE)."
                FINAL_EXIT_CODE=$EXIT_CODE
              fi
            }
          done
          exit $FINAL_EXIT_CODE

      - name: Upload Pa11y reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pa11y-reports
          path: pa11y-reports

  # ðŸŸ§ LIGHTHOUSE (PERFORMANCE + SEO + ACCESIBILIDAD)
  lighthouse:
    runs-on: ubuntu-latest
    needs: [build, tests]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist --no-progress

      - name: Seed storage
        run: |
          mkdir -p storage/json storage/logs
          if [ -d storage.example ]; then
            cp -r storage.example/* storage/json/ || true
            for f in storage.example/*.json; do
              basename_f=$(basename "$f")
              [ -f "$f" ] && cp -n "$f" "storage/$basename_f" || true
            done
          fi
          # Permisos para que PHP pueda escribir
          chmod -R 777 storage

      - name: Start PHP server
        run: php -S 0.0.0.0:8080 -t public public/index.php >/tmp/php-server-lh.log 2>&1 &

      - name: Wait for PHP server
        run: sleep 5

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v11
        with:
          configPath: ./lighthouserc.json
          uploadArtifacts: false
          temporaryPublicStorage: false

  # ðŸŸ© PLAYWRIGHT (E2E)
  playwright:
    runs-on: ubuntu-latest
    needs: [build, tests]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, dom, json, pdo, sqlite, curl

      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist --no-progress

      - name: Seed storage
        run: |
          mkdir -p storage/json storage/logs
          if [ -d storage.example ]; then
            cp -r storage.example/* storage/json/ || true
            for f in storage.example/*.json; do
              basename_f=$(basename "$f")
              [ -f "$f" ] && cp -n "$f" "storage/$basename_f" || true
            done
          fi
          # Permisos para que PHP pueda escribir
          chmod -R 777 storage

      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Node dependencies
        run: npm ci

      - name: Install Playwright (Chromium)
        run: npx playwright install --with-deps chromium

      - name: Prepare e2e tests folder
        run: mkdir -p tests/e2e

      - name: Generate Playwright config
        run: |
          cat > playwright.config.cjs <<'EOF'
          const { defineConfig } = require('@playwright/test');
          module.exports = defineConfig({
            testDir: 'tests/e2e',
            reporter: 'line',
            use: {
              baseURL: 'http://localhost:8080',
              browserName: 'chromium',
              headless: true,
              trace: 'on',
              video: 'on',
              screenshot: 'on'
            }
          });
          EOF

      - name: Create .env for Playwright Server
        run: |
          cat > .env <<EOF
          APP_ENV=testing
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          INTERNAL_API_KEY=${{ secrets.INTERNAL_KEY }}
          INTERNAL_CALLER=iamasterbigschool.contenido.creawebes.com
          SKIP_TOKEN_LOG=true
          RAG_SERVICE_URL=https://rag-service.contenido.creawebes.com/rag/heroes
          RAG_BASE_URL=https://rag-service.contenido.creawebes.com
          OPENAI_SERVICE_URL=https://openai-service.contenido.creawebes.com/v1/chat
          EOF
          echo "âœ… .env creado para tests de Playwright"

      - name: Start PHP server
        run: |
          # Exportar variables para que el proceso en background las herede
          export APP_ENV=testing
          export OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}"
          export INTERNAL_API_KEY="${{ secrets.INTERNAL_KEY }}"
          export INTERNAL_CALLER="iamasterbigschool.contenido.creawebes.com"
          export SKIP_TOKEN_LOG="true"
          export RAG_SERVICE_URL="https://rag-service.contenido.creawebes.com/rag/heroes"
          export RAG_BASE_URL="https://rag-service.contenido.creawebes.com"
          export OPENAI_SERVICE_URL="https://openai-service.contenido.creawebes.com/v1/chat"
          php -S 0.0.0.0:8080 -t public >/tmp/php-server.log 2>&1 &

      - name: Wait for PHP server
        run: sleep 5

      - name: Run Playwright tests
        run: npx playwright test tests/e2e --config=playwright.config.cjs
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          INTERNAL_API_KEY: ${{ secrets.INTERNAL_KEY }}
          INTERNAL_CALLER: iamasterbigschool.contenido.creawebes.com
          RAG_SERVICE_URL: https://rag-service.contenido.creawebes.com/rag/heroes
          RAG_BASE_URL: https://rag-service.contenido.creawebes.com
          OPENAI_SERVICE_URL: https://openai-service.contenido.creawebes.com/v1/chat

      - name: Upload Playwright artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-artifacts
          path: |
            playwright-report/
            test-results/
