name: CI - Clean Marvel Tests

env:
  TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}

on:
  push:
    branches:
      - main
      - 'feature/*'
      - 'hotfix/*'
      - 'release/*'
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PHP 8.4
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: mbstring, dom, json, pdo, sqlite
          coverage: xdebug

      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist --no-progress

      # TODO: decidir si este paso debe fallar el pipeline cuando detecte vulnerabilidades conocidas.
      - name: Composer security audit
        run: composer security:audit
        continue-on-error: true

      - name: Validate Composer configuration
        run: composer validate --strict

      - name: Run PHPUnit tests
        run: |
          if [ -f vendor/bin/phpunit ]; then
            XDEBUG_MODE=coverage vendor/bin/phpunit --testdox --configuration phpunit.xml.dist --coverage-clover coverage.xml
          else
            echo "PHPUnit no encontrado"
            exit 1
          fi

      - name: Run PHPStan analysis
        run: |
          if [ -f vendor/bin/phpstan ]; then
            vendor/bin/phpstan analyse --memory-limit=1G
          else
            echo "PHPStan no encontrado"
            exit 1
          fi

  tests:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Confirm existing test stage
        run: echo "Tests ejecutados en el job build; etapa placeholder para dependencias posteriores."

  # ðŸŸª SONARCLOUD (CALIDAD + BUGS + VULNERABILIDADES + COVERAGE)
  sonarcloud:
    runs-on: ubuntu-latest
    needs: [build, tests]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup PHP 8.4 con Xdebug (coverage)
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: mbstring, dom, json, pdo, sqlite
          coverage: xdebug

      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist --no-progress

      - name: Generar bundle size (JS/CSS)
        run: php bin/generate-bundle-size.php

      - name: Run PHPUnit with coverage
        run: |
          XDEBUG_MODE=coverage vendor/bin/phpunit \
            --configuration phpunit.xml.dist \
            --coverage-clover=coverage.xml

      - name: Assert coverage report exists
        run: |
          test -f coverage.xml
          ls -lh coverage.xml
          python3 - <<'PY'
          import xml.etree.ElementTree as ET
          root = ET.parse('coverage.xml').getroot()
          statements = covered = 0
          for m in root.findall('.//metrics'):
              statements += int(m.get('statements', 0))
              covered += int(m.get('coveredstatements', 0))
          percent = (covered / statements * 100) if statements else 0
          print(f"Coverage summary: covered {covered}/{statements} statements = {percent:.2f}%")
          PY

      - name: SonarCloud Scan
        uses: sonarsource/sonarcloud-github-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: >
            -Dsonar.php.coverage.reportPaths=coverage.xml

  # ðŸŸ¦ PA11Y (ACCESIBILIDAD AA)
  pa11y:
    runs-on: ubuntu-latest
    needs: [build, tests]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist --no-progress

      - name: Seed JSON storage
        run: |
          mkdir -p storage/json
          if [ -d storage.example ]; then
            cp -r storage.example/* storage/json/ || true
            for f in storage.example/*.json; do
              [ -f "$f" ] && cp -n "$f" "storage/$(basename "$f")" || true
            done
          fi

      - name: Install Node dependencies
        run: npm ci

      - name: Start PHP server (router)
        run: php -S 0.0.0.0:8080 -t public public/index.php >/tmp/php-server.log 2>&1 &

      - name: Run Pa11y audits
        run: |
          mkdir -p pa11y-reports
          urls=(/ /heroes /albums /comic /movies)
          FINAL_EXIT_CODE=0
          for url in "${urls[@]}"; do
            safe_name=$(echo "${url#/}" | tr '/' '-')
            if [ "$url" == "/" ]; then safe_name="index"; fi
            echo "Running Pa11y for http://localhost:8080${url}"
            npx pa11y "http://localhost:8080${url}" --standard WCAG2AA --reporter json --chrome-args="--no-sandbox --disable-setuid-sandbox" > "pa11y-reports/${safe_name}.json" || {
              EXIT_CODE=$?
              if [ $EXIT_CODE -eq 1 ]; then
                echo "Pa11y found accessibility issues in ${url} (exit code 1), but this will not fail the job."
              else
                echo "Pa11y failed to run for ${url} (exit code $EXIT_CODE)."
                FINAL_EXIT_CODE=$EXIT_CODE
              fi
            }
          done
          exit $FINAL_EXIT_CODE

      - name: Upload Pa11y reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pa11y-reports
          path: pa11y-reports

  # ðŸŸ§ LIGHTHOUSE (PERFORMANCE + SEO + ACCESIBILIDAD)
  lighthouse:
    runs-on: ubuntu-latest
    needs: [build, tests]
    continue-on-error: true
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist --no-progress

      - name: Seed JSON storage
        run: |
          mkdir -p storage/json
          if [ -d storage.example ]; then
            cp -r storage.example/* storage/json/ || true
            for f in storage.example/*.json; do
              [ -f "$f" ] && cp -n "$f" "storage/$(basename "$f")" || true
            done
          fi

      - name: Start PHP server
        run: php -S 0.0.0.0:8080 -t public public/index.php >/tmp/php-server-lh.log 2>&1 &

      - name: Wait for PHP server
        run: sleep 5

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v11
        with:
          configPath: ./lighthouserc.json
          uploadArtifacts: false
          temporaryPublicStorage: false

  # ðŸŸ© PLAYWRIGHT (E2E)
  playwright:
    runs-on: ubuntu-latest
    needs: [build, tests]
    continue-on-error: true
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist --no-progress

      - name: Seed JSON storage
        run: |
          mkdir -p storage/json
          if [ -d storage.example ]; then
            cp -r storage.example/* storage/json/ || true
            for f in storage.example/*.json; do
              [ -f "$f" ] && cp -n "$f" "storage/$(basename "$f")" || true
            done
          fi

      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Node dependencies
        run: npm ci

      - name: Install Playwright (Chromium)
        run: npx playwright install --with-deps chromium

      - name: Prepare e2e tests folder
        run: mkdir -p tests/e2e

      - name: Generate Playwright config
        run: |
          cat > playwright.config.cjs <<'EOF'
          const { defineConfig } = require('@playwright/test');
          module.exports = defineConfig({
            testDir: 'tests/e2e',
            reporter: 'line',
            use: {
              baseURL: 'http://localhost:8080',
              browserName: 'chromium',
              headless: true,
              trace: 'on',
              video: 'on',
              screenshot: 'on'
            }
          });
          EOF

      - name: Start PHP server
        run: php -S 0.0.0.0:8080 -t public public/index.php >/tmp/php-server.log 2>&1 &

      - name: Wait for PHP server
        run: sleep 5

      - name: Run Playwright tests
        run: npx playwright test tests/e2e --config=playwright.config.cjs

      - name: Upload Playwright artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-artifacts
          path: |
            playwright-report/
            test-results/
