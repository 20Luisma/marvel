name: Deploy Staging (PR Preview)

on:
  push:
    branches:
      - staging-final
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
  workflow_dispatch:

jobs:
  quality_gate:
    name: Quality Gate (Staging)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, pdo, pdo_mysql, json
          coverage: none

      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist

      - name: Run PHPUnit
        run: vendor/bin/phpunit --colors=always --testdox

      - name: Run PHPStan
        run: vendor/bin/phpstan analyse --memory-limit=1G

  deploy_staging:
    name: Deploy to Staging Subdomains
    needs: quality_gate
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Crear archivo de auditorÃ­a del PR
        run: |
          cat > DEPLOY_STAGING_PR.txt <<EOF
          Servicio: Clean Marvel Album (STAGING)
          Branch: ${{ github.ref_name }}
          Commit: ${{ github.sha }}
          Autor: ${{ github.actor }}
          Fecha/hora (UTC): $(date -u '+%Y-%m-%d %H:%M:%S')
          EOF

      - name: Deploy a Staging (Hostinger)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USER }}
          password: ${{ secrets.FTP_PASS }}
          protocol: ftp
          port: ${{ secrets.FTP_PORT }}
          timeout: 1200000

          # ðŸ“Œ RUTA RAÃZ DE STAGING
          server-dir: /domains/contenido.creawebes.com/public_html/clean-marvel-staging/
          
          local-dir: ./
          state-name: ftp-state-staging.json

          exclude: |
            .git/**
            **/.git/**
            **/.git*
            **/.github/**
            node_modules/**
            .scannerwork/**
            tests/**
            openai-service/**
            rag-service/**
            **/*.log
            pa11y-*.sh
            package-lock.json
            package.json
            playwright.config.cjs
            test-results/**
            blob-report/**
            playwright-report/**
            coverage.xml
            .phpunit.result.cache
            vendor/**
            openai-service/vendor/**
            rag-service/vendor/**
