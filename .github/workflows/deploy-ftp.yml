name: Deploy Marvel a Hostinger (FTP)

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      motivo:
        description: "Motivo del deploy"
        required: false
        default: "Deploy manual"

jobs:
  quality_gate:
    name: ðŸ›¡ï¸ Filtro de Calidad QuirÃºrgico
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, dom, json, pdo, sqlite, curl

      - name: Install dependencies
        run: |
          composer install --no-interaction
          npm ci
          
      - name: Seed storage
        run: |
          mkdir -p storage/json storage/logs
          if [ -d storage.example ]; then
            cp -r storage.example/* storage/json/ || true
            for f in storage.example/*.json; do
              basename_f=$(basename "$f")
              [ -f "$f" ] && cp -n "$f" "storage/$basename_f" || true
            done
          fi
          # Permisos para que PHP pueda escribir
          chmod -R 777 storage

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps chromium

      - name: Start Surgical Server
        run: php -S 0.0.0.0:8080 -t public >/tmp/surgical-server.log 2>&1 &
        env:
          APP_ENV: testing
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          INTERNAL_API_KEY: ${{ secrets.INTERNAL_KEY }}
          RAG_SERVICE_URL: https://rag-service.contenido.creawebes.com/rag/heroes
          RAG_BASE_URL: https://rag-service.contenido.creawebes.com

      - name: ðŸ”¬ Ejecutar Test QuirÃºrgico (PRE-DEPLOY)
        run: |
          sleep 5
          npx playwright test tests/e2e/surgical-production-check.spec.js --config=playwright.config.cjs
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          INTERNAL_API_KEY: ${{ secrets.INTERNAL_KEY }}
          RAG_SERVICE_URL: https://rag-service.contenido.creawebes.com/rag/heroes
          RAG_BASE_URL: https://rag-service.contenido.creawebes.com
          # Usamos staging para validar que los microservicios externos estÃ¡n vivos
          PLAYWRIGHT_BASE_URL: http://localhost:8080

      - name: âŒ Reporte de Error QuirÃºrgico
        if: failure()
        run: |
          echo "::error::EL TEST QUIRÃšRGICO HA FALLADO. El deploy se ha abortado para proteger la producciÃ³n."
          cat /tmp/surgical-server.log

  deploy_app:
    name: Deploy app principal
    runs-on: ubuntu-latest
    needs: quality_gate

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Generar bundle size (JS/CSS)
        run: php bin/generate-bundle-size.php

      - name: Crear archivo prueba (APP)
        run: |
          cat > DEPLOY_TEST_APP.txt <<EOF
          Servicio: Clean Marvel Album (APP principal)
          Fecha/hora (UTC): $(date -u '+%Y-%m-%d %H:%M:%S')
          Mensaje: Si ves este archivo, el deploy funciona.
          EOF

      ####################################################################
      # 1) Deploy APP PRINCIPAL (server-dir: iamasterbigschool)
      ####################################################################
      - name: Deploy app principal (iamasterbigschool)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USER }}
          password: ${{ secrets.FTP_PASS }}
          protocol: ftp
          port: ${{ secrets.FTP_PORT }}
          timeout: 1800000
          log-level: verbose

          # ðŸ“Œ RUTA REAL DEL PROYECTO COMPLETO EN HOSTINGER
          server-dir: /domains/contenido.creawebes.com/public_html/iamasterbigschool/

          # ðŸ“Œ Subimos TODO el proyecto (NO solo public)
          local-dir: ./

          # âœ… Estado aislado (evita colisiones entre despliegues)
          state-name: ftp-state-app.json

          # ðŸ“Œ Archivos/carpetas que NO deben subirse
          exclude: |
            **/.git*
            **/.github/**
            node_modules/**
            tests/**
            .scannerwork/**
            coverage.xml
            pa11y-*.sh
            package-lock.json
            package.json
            playwright.config.cjs
            test-results/**
            blob-report/**
            playwright-report/**
            openai-service/**
            rag-service/**
            presentation/assets/app/**

  deploy_openai:
    name: Deploy openai-service
    runs-on: ubuntu-latest
    needs: deploy_app

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Crear archivo prueba (OPENAI)
        run: |
          cat > openai-service/DEPLOY_TEST_OPENAI.txt <<EOF
          Servicio: openai-service
          Fecha/hora (UTC): $(date -u '+%Y-%m-%d %H:%M:%S')
          Mensaje: Si ves este archivo, el deploy funciona.
          EOF

      ####################################################################
      # 2) Deploy microservicio OPENAI
      ####################################################################
      - name: Deploy microservicio openai-service
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USER }}
          password: ${{ secrets.FTP_PASS }}
          protocol: ftp
          port: ${{ secrets.FTP_PORT }}
          timeout: 1800000
          log-level: verbose

          server-dir: /domains/contenido.creawebes.com/public_html/openai-service/
          local-dir: ./openai-service/

          # âœ… Estado aislado (evita colisiones entre despliegues)
          state-name: ftp-state-openai.json

  deploy_rag:
    name: Deploy rag-service
    runs-on: ubuntu-latest
    needs: deploy_openai

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Crear archivo prueba (RAG)
        run: |
          cat > rag-service/DEPLOY_TEST_RAG.txt <<EOF
          Servicio: rag-service
          Fecha/hora (UTC): $(date -u '+%Y-%m-%d %H:%M:%S')
          Mensaje: Si ves este archivo, el deploy funciona.
          EOF

      ####################################################################
      # 3) Deploy microservicio RAG
      ####################################################################
      - name: Deploy microservicio rag-service
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USER }}
          password: ${{ secrets.FTP_PASS }}
          protocol: ftp
          port: ${{ secrets.FTP_PORT }}
          timeout: 1800000
          log-level: verbose

          server-dir: /domains/contenido.creawebes.com/public_html/rag-service/
          local-dir: ./rag-service/

          # âœ… Estado aislado (evita colisiones entre despliegues)
          state-name: ftp-state-rag.json
# Triggering re-run to verify RAG diagnostic
# Retry at Wed Feb  4 20:06:22 CET 2026
