[
    {
        "id": "section-1",
        "title": "1. Resumen general del proyecto",
        "text": "- **Clean Marvel Album** es una aplicación PHP 8.x con arquitectura en capas (Clean Architecture) que:\n  - Gestiona álbumes, héroes y secciones especiales (Secret Room).\n  - Orquesta microservicios dedicados (RAG, OpenAI, Heatmap).\n  - Integra calidad, accesibilidad y pruebas automáticas mediante CI/CD.\n\n- **Tecnologías principales**:\n  - PHP 8.x en la app principal y microservicios (`rag-service`, `openai-service`).\n  - Python + Flask en el `heatmap-service`.\n  - Frontend basado en vistas PHP + HTML + CSS + JS sin framework frontend grande.\n  - SQLite en el microservicio de heatmap; ficheros JSON para knowledge base y embeddings.\n\n- **Arquitectura limpia**:\n  - **Presentación**: controladores HTTP y vistas (`views/*`, `PageController`, `Router`).\n  - **Aplicación**: casos de uso y servicios de orquestación (RAG, generación de contenido, etc.).\n  - **Dominio**: entidades, contratos e interfaces.\n  - **Infraestructura**: repositorios, clientes HTTP, acceso a ficheros, integración con APIs externas.\n\n- **Microservicios actuales**:\n  - `rag-service`: comparación de héroes mediante RAG ligero.\n  - `openai-service`: fachada HTTP a la API de OpenAI para chat/contenido.\n  - `heatmap-service`: tracking y visualización de clics en la web Marvel.\n\n- **Secciones clave de la app**:\n  - `/albums`, `/heroes`: navegación principal de contenido Marvel.\n  - `/comic`: generación de historias/cómics usando OpenAI.\n  - `/seccion` (Secret Room): panel central técnico (Sonar, Sentry, Heatmap, etc.).\n  - `/agentia`: interfaz del **Marvel Agent** (chat técnico, inicialmente simulado).\n\n---"
    },
    {
        "id": "section-2",
        "title": "2. Arquitectura técnica unificada",
        "text": ""
    },
    {
        "id": "section-3",
        "title": "2.1 App principal (PHP)",
        "text": "- **Routing principal**:\n  - `Src\\Shared\\Http\\Router` y `PageController` mapean rutas como `/`, `/albums`, `/heroes`, `/comic`, `/seccion`, `/agentia`, etc., y cargan vistas en `views/*.php`.\n\n- **Vistas principales** (ejemplos):\n  - `views/albums.php`: listado y gestión de álbumes.\n  - `views/heroes.php`: listado de héroes.\n  - `views/comic.php`: interfaz para generación de cómics.\n  - `views/seccion.php`: **Secret Room**, panel técnico (SonarCloud, Sentry, Heatmap, GitHub PRs, accesibilidad, performance, repo, etc.).\n  - `views/agentia.php`: interfaz del **Marvel Agent**:\n    - Cabecera alineada al estilo de Secret Room.\n    - Panel de chat con mensajes simulados.\n    - Panel lateral con ejemplos de preguntas y explicación del agente.\n\n- **Frontend**:\n  - CSS en `public/assets/css/*`, con estilos reutilizables para tarjetas, botones y grids.\n  - JS específico por página:\n    - `comic.js` (cómic/RAG),\n    - scripts de heatmap, Secret Room, etc.\n    - `agentia.js` (chat simulado, sin backend real).\n\n- **APIs/proxies internos**:\n  - Scripts PHP en `public/api/` (ej. heatmap, accesibilidad, performance, GitHub, Sentry, Sonar, TTS).\n  - Objetivo: ocultar credenciales y normalizar payloads antes de llamar a servicios externos o microservicios."
    },
    {
        "id": "section-4",
        "title": "2.2 Microservicio `rag-service` (RAG de héroes)",
        "text": "- **Responsabilidad**: comparar héroes usando RAG ligero y devolver una respuesta generada por LLM con contexto.\n- **Endpoint**: `POST /rag/heroes`.\n- **Request típico**:\n  ```json\n  {\n    \"heroIds\": [\"ironman\", \"captain-america\"],\n    \"question\": \"¿En qué se parecen y en qué se diferencian?\"\n  }\n  ```\n- **Response típico**:\n  ```json\n  {\n    \"answer\": \"Respuesta generada por el LLM...\",\n    \"contexts\": [\n      { \"heroId\": \"ironman\", \"nombre\": \"Iron Man\", \"contenido\": \"...\", \"score\": 0.92 },\n      { \"heroId\": \"captain-america\", \"nombre\": \"Captain America\", \"contenido\": \"...\", \"score\": 0.89 }\n    ],\n    \"heroIds\": [\"ironman\", \"captain-america\"]\n  }\n  ```\n\n- **Casos de uso / servicios**:\n  - `HeroRagService::compare(array $heroIds, ?string $question)`: valida heroIds/pregunta, recupera contextos, construye prompt narrativo y llama a `openai-service`.\n\n- **Knowledge base**:\n  - `storage/knowledge/heroes.json` (heroId, nombre, contenido).\n  - Embeddings opcionales en `storage/embeddings/heroes.json`.\n\n- **Retrievers**:\n  - Léxico (default): `HeroRetriever` (bolsa de palabras + coseno).\n  - Vectorial (opcional): `VectorHeroRetriever` usa embeddings precalculados y cae al léxico si faltan vectores o config.\n\n- **Cliente hacia OpenAI**:\n  - `OpenAiHttpClient` llama al microservicio `openai-service` (nunca directo a OpenAI).\n\n- **Configuración relevante** (`rag-service/.env`):\n  - `OPENAI_SERVICE_URL`\n  - `RAG_USE_EMBEDDINGS`\n  - `RAG_EMBEDDINGS_AUTOREFRESH`\n\n- **Tests**: suite propia en `rag-service/tests/` con `phpunit.xml`."
    },
    {
        "id": "section-5",
        "title": "2.3 Microservicio `openai-service` (fachada OpenAI)",
        "text": "- **Responsabilidad**: ofrecer un endpoint HTTP controlado hacia OpenAI.\n- **Endpoint**: `POST /v1/chat`.\n- **Request típico**:\n  ```json\n  {\n    \"messages\": [\n      { \"role\": \"system\", \"content\": \"Instrucciones...\" },\n      { \"role\": \"user\", \"content\": \"Pregunta del usuario...\" }\n    ]\n  }\n  ```\n- **Response típico**:\n  ```json\n  { \"ok\": true, \"content\": \"Texto generado por el modelo\" }\n  ```\n  o `{ \"ok\": false, \"error\": \"Mensaje de error\" }`.\n\n- **Flujo interno**:\n  - `public/index.php` → `Http\\Router` → `OpenAIController` → `Application\\UseCase\\GenerateContent` → `Infrastructure\\Client\\OpenAiClient` (Guzzle).\n  - `GenerateContent` limpia fences de código y genera fallback JSON en caso de fallo.\n\n- **Configuración** (`openai-service/.env`):\n  - `OPENAI_API_KEY` (obligatorio),\n  - `OPENAI_API_BASE` (default `https://api.openai.com/v1`),\n  - `OPENAI_MODEL` (default `gpt-4o-mini`),\n  - `ALLOWED_ORIGINS` para CORS.\n\n- **Tests**: suite propia en `openai-service/tests/` con `phpunit.xml`."
    },
    {
        "id": "section-6",
        "title": "2.4 Microservicio `heatmap-service` (clics y analítica)",
        "text": "- **Responsabilidad**: registrar clics y exponer eventos/visualización de heatmap.\n- **Tecnología**: Python + Flask + SQLite, dockerizado (VM).\n- **Endpoints externos**: `GET /`, `GET /health`, `POST /track` (X-API-Token), `GET /events` (filtros).\n- **Integración PHP**: proxies en `public/api/heatmap/*.php` inyectan `HEATMAP_API_TOKEN` y usan `HEATMAP_API_BASE_URL`. Panel en `/secret-heatmap`."
    },
    {
        "id": "section-7",
        "title": "2.5 Flujos clave",
        "text": "- **Generación de cómic**: frontend en `/comic` → `POST /comics/generate` (app principal) → `openai-service /v1/chat` → respuesta en vista.\n- **Comparación RAG**: frontend → `POST /rag/heroes` → retriever léxico/vectorial → `openai-service /v1/chat` → respuesta + contextos.\n- **Marvel Agent (/agentia)**: solo frontend; chat simulado con JS placeholder. El botón en Secret Room apunta a `/agentia`."
    },
    {
        "id": "section-8",
        "title": "2.6 Infraestructura, despliegue y hosting de microservicios",
        "text": "- **Mapa de despliegue (local)**:\n  - App principal (PHP): `localhost:8080` (también `docker-compose.yml` expone 8080).\n  - `openai-service` (PHP): `localhost:8081`, endpoint `POST /v1/chat`.\n  - `rag-service` (PHP): `localhost:8082`, endpoints `POST /rag/heroes` y `POST /rag/agent`.\n  - `heatmap-service` (Python/Flask): según docs, expuesto en `http://34.74.102.123:8080` (VM). Endpoints `/`, `/health`, `POST /track`, `GET /events`.\n- **Mapa de despliegue (hosting/producción)**:\n  - App principal: dominio principal indicado en `.env` (`APP_PUBLIC_URL`), hosting PHP.\n  - `openai-service`: subdominio documentado en bootstrap como fallback hosting: `https://openai-service.contenido.creawebes.com/v1/chat` si no hay `OPENAI_SERVICE_URL`.\n  - `rag-service`: subdominio para hosting: `https://rag-service.contenido.creawebes.com` (en bootstrap se detecta host) con rutas `/rag/heroes` y `/rag/agent`.\n  - `heatmap-service`: dockerizado en VM (Google Cloud, según docs) accesible en `http://34.74.102.123:8080`.\n- **Docker e imágenes**:\n  - `docker-compose.yml` (raíz): levanta la app principal PHP con servidor embebido en 8080.\n  - `heatmap-service`: tiene Dockerfile; se construye como imagen `heatmap-service` y se ejecuta en contenedor (`docker run -p 8080:8080 ...`). Volumen montado para `heatmap.db`.\n  - No hay Dockerfiles visibles para `rag-service` u `openai-service` en el repo; se sirven con `php -S` en local/hosting.\n- **Subdominios y hosting**:\n  - Los microservicios PHP resuelven su URL vía `.env` (`OPENAI_SERVICE_URL`, `RAG_SERVICE_URL`), con fallback a subdominios `openai-service.contenido.creawebes.com` y `rag-service.contenido.creawebes.com` cuando están en hosting.\n  - La app principal consume microservicios vía HTTP; proxies PHP (`public/api/*.php`) ocultan tokens y orquestan llamadas externas (heatmap, etc.).\n- **Entornos (resumen)**:\n  - Local: App 8080 / `openai-service` 8081 / `rag-service` 8082 / heatmap (VM 34.74.102.123:8080 o localhost si se levanta).\n  - Producción: App en hosting PHP (`APP_PUBLIC_URL`), `openai-service` y `rag-service` en subdominios configurados por `.env`/bootstrap, heatmap en VM Docker (IP/URL documentada).\n- **RAG-service compartido**:\n  - Un único `rag-service` expone dos endpoints:\n    - `/rag/heroes` para comparación de héroes.\n    - `/rag/agent` para preguntas técnicas usando la memoria maestra (`storage/marvel_agent_kb.json`).\n  - Ambos flujos reutilizan el mismo cliente hacia `openai-service`.\n\n---"
    },
    {
        "id": "section-9",
        "title": "3. Calidad, CI y auditorías",
        "text": "- **Pruebas**:\n  - App principal: `phpunit.xml.dist`.\n  - Microservicios: `rag-service/phpunit.xml`, `openai-service/phpunit.xml`.\n  - Comandos típicos:\n    - `vendor/bin/phpunit`\n    - `cd rag-service && ../vendor/bin/phpunit`\n    - `cd openai-service && ../vendor/bin/phpunit`\n\n- **PHPStan**: `vendor/bin/phpstan analyse --memory-limit=512M` (config en `phpstan.neon`, excluye `src/Dev`).\n\n- **QA frontend**: Playwright (`playwright.config.cjs`), Pa11y (`pa11y-all.sh`), Lighthouse (`lighthouserc.json`), SonarCloud (ver ADR-003).\n\n- **CI/CD (GitHub Actions)**: jobs de PHPUnit, PHPStan, Pa11y, Lighthouse, Playwright, SonarCloud; deploy/rollback FTP según pipelines definidos.\n\n---"
    },
    {
        "id": "section-10",
        "title": "4. Documentación y fuentes de conocimiento",
        "text": "- **Índice general**: `docs/README.md`.\n- **Arquitectura**: `docs/ARCHITECTURE.md`; ADRs en `docs/architecture/ADR-*.md`.\n- **APIs**: `docs/API_REFERENCE.md` (usa endpoints reales: `/comics/generate`, `/rag/heroes`, `/v1/chat`, proxies heatmap).\n- **Microservicios**:\n  - `rag-service/README.md`, `rag-service/doc/*`.\n  - `openai-service/doc/*`.\n  - `docs/microservicioheatmap/README.md`.\n- **Guías y otros**: `docs/guides/getting-started.md`, `docs/guides/testing.md`, `docs/guides/authentication.md`, `docs/USE_CASES.md`, `docs/ROADMAP.md`, `docs/TASKS_AUTOMATION.md`.\n\n---"
    },
    {
        "id": "section-11",
        "title": "5. Reglas para el futuro Marvel Agent",
        "text": "1. **Fuentes permitidas**: este archivo, la documentación listada y el código real. Si hay conflicto, prevalece el código.\n2. **No inventar**: no crear endpoints ni microservicios inexistentes. Si falta información, indicarlo.\n3. **Citar**: mencionar el archivo de soporte cuando aplique (ej.: `docs/ARCHITECTURE.md`, `rag-service/README.md`).\n4. **Endpoints reales**: `/v1/chat` (openai-service), `/rag/heroes` (rag-service), proxies heatmap (`/api/heatmap/*.php`), rutas HTML según `PageController`.\n5. **Configuración**: hablar solo de variables que estén en `.env` o en código (`OPENAI_API_KEY`, `OPENAI_SERVICE_URL`, `RAG_USE_EMBEDDINGS`, `HEATMAP_API_*`, etc.).\n6. **Estado del agente**: `/agentia` es frontend con respuestas simuladas; el backend RAG/LLM se añadirá después usando esta memoria.\n7. **Infra y despliegue**: el agente puede responder dónde corren microservicios (subdominios, hosting, VM/Google Cloud) y qué está dockerizado, solo si está documentado aquí, en los docs listados o en configuración real. Si falta info, debe decir que no está documentado.\n\n---\n\n> Cuando se actualice esta memoria, es necesario regenerar la KB ejecutando:  \n> `cd rag-service && php bin/build_marvel_agent_kb.php`"
    }
]